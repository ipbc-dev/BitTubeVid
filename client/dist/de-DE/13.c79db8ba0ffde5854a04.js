(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{"0ovO":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("NOtv"),n=s("A+nu");t.HttpMediaManager=class extends n.STEEmitter{constructor(e){super(),this.settings=e,this.xhrRequests=new Map,this.failedSegments=new Map,this.debug=i("p2pml:http-media-manager"),this.now=()=>performance.now()}download(e,t){if(this.isDownloading(e))return;this.cleanTimedOutFailedSegments();const s=this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(e):e.url;this.debug("http segment download",s),e.requestUrl=s;const i=new XMLHttpRequest;if(i.open("GET",s,!0),i.responseType="arraybuffer",e.range)i.setRequestHeader("Range",e.range),t=void 0;else if(void 0!==t&&this.settings.httpUseRanges){let e=0;for(const s of t)e+=s.byteLength;i.setRequestHeader("Range",`bytes=${e}-`),this.debug("continue download from",e)}else t=void 0;this.setupXhrEvents(i,e,t),this.settings.xhrSetup&&this.settings.xhrSetup(i,s),this.xhrRequests.set(e.id,{xhr:i,segment:e}),i.send()}abort(e){const t=this.xhrRequests.get(e.id);t&&(t.xhr.abort(),this.xhrRequests.delete(e.id),this.debug("http segment abort",e.id))}isDownloading(e){return this.xhrRequests.has(e.id)}isFailed(e){const t=this.failedSegments.get(e.id);return void 0!==t&&t>this.now()}getActiveDownloads(){return this.xhrRequests}getActiveDownloadsCount(){return this.xhrRequests.size}destroy(){this.xhrRequests.forEach(e=>e.xhr.abort()),this.xhrRequests.clear()}setupXhrEvents(e,t,s){let i=0;e.addEventListener("progress",e=>{this.emit("bytes-downloaded",e.loaded-i),i=e.loaded}),e.addEventListener("load",async i=>{if(i.target.status<200||i.target.status>=300)return void this.segmentFailure(t,i,e);let n=i.target.response;if(void 0!==s&&206===i.target.status){let e=0;for(const n of s)e+=n.byteLength;const t=new Uint8Array(e+n.byteLength);let i=0;for(const n of s)t.set(new Uint8Array(n),i),i+=n.byteLength;t.set(new Uint8Array(n),i),n=t.buffer}await this.segmentDownloadFinished(t,n,e)}),e.addEventListener("error",s=>{this.segmentFailure(t,s,e)}),e.addEventListener("timeout",s=>{this.segmentFailure(t,s,e)})}async segmentDownloadFinished(e,t,s){if(e.responseUrl=null===s.responseURL?void 0:s.responseURL,this.settings.segmentValidator)try{await this.settings.segmentValidator(Object.assign(Object.assign({},e),{data:t}),"http")}catch(i){return this.debug("segment validator failed",i),void this.segmentFailure(e,i,s)}this.xhrRequests.delete(e.id),this.emit("segment-loaded",e,t)}segmentFailure(e,t,s){e.responseUrl=null===s.responseURL?void 0:s.responseURL,this.xhrRequests.delete(e.id),this.failedSegments.set(e.id,this.now()+this.settings.httpFailedSegmentTimeout),this.emit("segment-error",e,t)}cleanTimedOutFailedSegments(){const e=this.now(),t=[];this.failedSegments.forEach((s,i)=>{s<e&&t.push(i)}),t.forEach(e=>this.failedSegments.delete(e))}}},"10ky":function(e,t,s){"use strict";s.r(t),s.d(t,"LineStream",function(){return m}),s.d(t,"ParseStream",function(){return p}),s.d(t,"Parser",function(){return f});var i=s("Rz0W"),n=s.n(i),r=function(){function e(){this.listeners={}}var t=e.prototype;return t.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},t.off=function(e,t){if(!this.listeners[e])return!1;var s=this.listeners[e].indexOf(t);return this.listeners[e]=this.listeners[e].slice(0),this.listeners[e].splice(s,1),s>-1},t.trigger=function(e){var t=this.listeners[e];if(t)if(2===arguments.length)for(var s=t.length,i=0;i<s;++i)t[i].call(this,arguments[1]);else for(var n=Array.prototype.slice.call(arguments,1),r=t.length,a=0;a<r;++a)t[a].apply(this,n)},t.dispose=function(){this.listeners={}},t.pipe=function(e){this.on("data",function(t){e.push(t)})},e}(),a=s("SM4Z"),o=s.n(a),d=s("GE+h"),g=s.n(d),h=s("vgmO"),l=s.n(h);function u(e){for(var t,s=(t=e,l.a.atob?l.a.atob(t):Buffer.from(t,"base64").toString("binary")),i=new Uint8Array(s.length),n=0;n<s.length;n++)i[n]=s.charCodeAt(n);return i}var m=function(e){function t(){var t;return(t=e.call(this)||this).buffer="",t}return n()(t,e),t.prototype.push=function(e){var t;for(this.buffer+=e,t=this.buffer.indexOf("\n");t>-1;t=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,t)),this.buffer=this.buffer.substring(t+1)},t}(r),c=function(e){for(var t,s=e.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),i={},n=s.length;n--;)""!==s[n]&&((t=/([^=]*)=(.*)/.exec(s[n]).slice(1))[0]=t[0].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^\s+|\s+$/g,""),t[1]=t[1].replace(/^['"](.*)['"]$/g,"$1"),i[t[0]]=t[1]);return i},p=function(e){function t(){var t;return(t=e.call(this)||this).customParsers=[],t.tagMappers=[],t}n()(t,e);var s=t.prototype;return s.push=function(e){var t,s,i=this;0!==(e=e.trim()).length&&("#"===e[0]?this.tagMappers.reduce(function(t,s){var i=s(e);return i===e?t:t.concat([i])},[e]).forEach(function(e){for(var n=0;n<i.customParsers.length;n++)if(i.customParsers[n].call(i,e))return;if(0===e.indexOf("#EXT"))if(e=e.replace("\r",""),t=/^#EXTM3U/.exec(e))i.trigger("data",{type:"tag",tagType:"m3u"});else{if(t=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(e))return s={type:"tag",tagType:"inf"},t[1]&&(s.duration=parseFloat(t[1])),t[2]&&(s.title=t[2]),void i.trigger("data",s);if(t=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(e))return s={type:"tag",tagType:"targetduration"},t[1]&&(s.duration=parseInt(t[1],10)),void i.trigger("data",s);if(t=/^#ZEN-TOTAL-DURATION:?([0-9.]*)?/.exec(e))return s={type:"tag",tagType:"totalduration"},t[1]&&(s.duration=parseInt(t[1],10)),void i.trigger("data",s);if(t=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(e))return s={type:"tag",tagType:"version"},t[1]&&(s.version=parseInt(t[1],10)),void i.trigger("data",s);if(t=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return s={type:"tag",tagType:"media-sequence"},t[1]&&(s.number=parseInt(t[1],10)),void i.trigger("data",s);if(t=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(e))return s={type:"tag",tagType:"discontinuity-sequence"},t[1]&&(s.number=parseInt(t[1],10)),void i.trigger("data",s);if(t=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(e))return s={type:"tag",tagType:"playlist-type"},t[1]&&(s.playlistType=t[1]),void i.trigger("data",s);if(t=/^#EXT-X-BYTERANGE:?([0-9.]*)?@?([0-9.]*)?/.exec(e))return s={type:"tag",tagType:"byterange"},t[1]&&(s.length=parseInt(t[1],10)),t[2]&&(s.offset=parseInt(t[2],10)),void i.trigger("data",s);if(t=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(e))return s={type:"tag",tagType:"allow-cache"},t[1]&&(s.allowed=!/NO/.test(t[1])),void i.trigger("data",s);if(t=/^#EXT-X-MAP:?(.*)$/.exec(e)){if(s={type:"tag",tagType:"map"},t[1]){var r=c(t[1]);if(r.URI&&(s.uri=r.URI),r.BYTERANGE){var a=r.BYTERANGE.split("@"),o=a[0],d=a[1];s.byterange={},o&&(s.byterange.length=parseInt(o,10)),d&&(s.byterange.offset=parseInt(d,10))}}i.trigger("data",s)}else if(t=/^#EXT-X-STREAM-INF:?(.*)$/.exec(e)){if(s={type:"tag",tagType:"stream-inf"},t[1]){if(s.attributes=c(t[1]),s.attributes.RESOLUTION){var g=s.attributes.RESOLUTION.split("x"),h={};g[0]&&(h.width=parseInt(g[0],10)),g[1]&&(h.height=parseInt(g[1],10)),s.attributes.RESOLUTION=h}s.attributes.BANDWIDTH&&(s.attributes.BANDWIDTH=parseInt(s.attributes.BANDWIDTH,10)),s.attributes["PROGRAM-ID"]&&(s.attributes["PROGRAM-ID"]=parseInt(s.attributes["PROGRAM-ID"],10))}i.trigger("data",s)}else{if(t=/^#EXT-X-MEDIA:?(.*)$/.exec(e))return s={type:"tag",tagType:"media"},t[1]&&(s.attributes=c(t[1])),void i.trigger("data",s);if(t=/^#EXT-X-ENDLIST/.exec(e))i.trigger("data",{type:"tag",tagType:"endlist"});else if(t=/^#EXT-X-DISCONTINUITY/.exec(e))i.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(t=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(e))return s={type:"tag",tagType:"program-date-time"},t[1]&&(s.dateTimeString=t[1],s.dateTimeObject=new Date(t[1])),void i.trigger("data",s);if(t=/^#EXT-X-KEY:?(.*)$/.exec(e))return s={type:"tag",tagType:"key"},t[1]&&(s.attributes=c(t[1]),s.attributes.IV&&("0x"===s.attributes.IV.substring(0,2).toLowerCase()&&(s.attributes.IV=s.attributes.IV.substring(2)),s.attributes.IV=s.attributes.IV.match(/.{8}/g),s.attributes.IV[0]=parseInt(s.attributes.IV[0],16),s.attributes.IV[1]=parseInt(s.attributes.IV[1],16),s.attributes.IV[2]=parseInt(s.attributes.IV[2],16),s.attributes.IV[3]=parseInt(s.attributes.IV[3],16),s.attributes.IV=new Uint32Array(s.attributes.IV))),void i.trigger("data",s);if(t=/^#EXT-X-START:?(.*)$/.exec(e))return s={type:"tag",tagType:"start"},t[1]&&(s.attributes=c(t[1]),s.attributes["TIME-OFFSET"]=parseFloat(s.attributes["TIME-OFFSET"]),s.attributes.PRECISE=/YES/.test(s.attributes.PRECISE)),void i.trigger("data",s);if(t=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(e))return(s={type:"tag",tagType:"cue-out-cont"}).data=t[1]?t[1]:"",void i.trigger("data",s);if(t=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(e))return(s={type:"tag",tagType:"cue-out"}).data=t[1]?t[1]:"",void i.trigger("data",s);if(t=/^#EXT-X-CUE-IN:?(.*)?$/.exec(e))return(s={type:"tag",tagType:"cue-in"}).data=t[1]?t[1]:"",void i.trigger("data",s);i.trigger("data",{type:"tag",data:e.slice(4)})}}}else i.trigger("data",{type:"comment",text:e.slice(1)})}):this.trigger("data",{type:"uri",uri:e}))},s.addParser=function(e){var t=this,s=e.expression,i=e.customType,n=e.dataParser,r=e.segment;"function"!=typeof n&&(n=function(e){return e}),this.customParsers.push(function(e){if(s.exec(e))return t.trigger("data",{type:"custom",data:n(e),customType:i,segment:r}),!0})},s.addTagMapper=function(e){var t=e.expression,s=e.map;this.tagMappers.push(function(e){return t.test(e)?s(e):e})},t}(r),f=function(e){function t(){var t;(t=e.call(this)||this).lineStream=new m,t.parseStream=new p,t.lineStream.pipe(t.parseStream);var s,i,n=g()(t),r=[],a={},d=function(){},h={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},l=0;t.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var c=0;return t.parseStream.on("data",function(e){var t,g;({tag:function(){({"allow-cache":function(){this.manifest.allowCache=e.allowed,"allowed"in e||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var t={};"length"in e&&(a.byterange=t,t.length=e.length,"offset"in e||(e.offset=c)),"offset"in e&&(a.byterange=t,t.offset=e.offset),c=t.offset+t.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),e.duration>0&&(a.duration=e.duration),0===e.duration&&(a.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=r},key:function(){if(e.attributes)if("NONE"!==e.attributes.METHOD)if(e.attributes.URI){if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===e.attributes.KEYFORMAT)return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(e.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===e.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==e.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):e.attributes.KEYID&&"0x"===e.attributes.KEYID.substring(0,2)?void(this.manifest.contentProtection={"com.widevine.alpha":{attributes:{schemeIdUri:e.attributes.KEYFORMAT,keyId:e.attributes.KEYID.substring(2)},pssh:u(e.attributes.URI.split(",")[1])}}):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}));e.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),i={method:e.attributes.METHOD||"AES-128",uri:e.attributes.URI},void 0!==e.attributes.IV&&(i.iv=e.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else i=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(e.number)?this.manifest.mediaSequence=e.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+e.number})},"discontinuity-sequence":function(){isFinite(e.number)?(this.manifest.discontinuitySequence=e.number,l=e.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+e.number})},"playlist-type":function(){/VOD|EVENT/.test(e.playlistType)?this.manifest.playlistType=e.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+e.playlist})},map:function(){s={},e.uri&&(s.uri=e.uri),e.byterange&&(s.byterange=e.byterange)},"stream-inf":function(){this.manifest.playlists=r,this.manifest.mediaGroups=this.manifest.mediaGroups||h,e.attributes?(a.attributes||(a.attributes={}),o()(a.attributes,e.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||h,e.attributes&&e.attributes.TYPE&&e.attributes["GROUP-ID"]&&e.attributes.NAME){var s=this.manifest.mediaGroups[e.attributes.TYPE];s[e.attributes["GROUP-ID"]]=s[e.attributes["GROUP-ID"]]||{},t=s[e.attributes["GROUP-ID"]],(g={default:/yes/i.test(e.attributes.DEFAULT)}).autoselect=!!g.default||/yes/i.test(e.attributes.AUTOSELECT),e.attributes.LANGUAGE&&(g.language=e.attributes.LANGUAGE),e.attributes.URI&&(g.uri=e.attributes.URI),e.attributes["INSTREAM-ID"]&&(g.instreamId=e.attributes["INSTREAM-ID"]),e.attributes.CHARACTERISTICS&&(g.characteristics=e.attributes.CHARACTERISTICS),e.attributes.FORCED&&(g.forced=/yes/i.test(e.attributes.FORCED)),t[e.attributes.NAME]=g}else this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){l+=1,a.discontinuity=!0,this.manifest.discontinuityStarts.push(r.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=e.dateTimeString,this.manifest.dateTimeObject=e.dateTimeObject),a.dateTimeString=e.dateTimeString,a.dateTimeObject=e.dateTimeObject},targetduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+e.duration}):this.manifest.targetDuration=e.duration},totalduration:function(){!isFinite(e.duration)||e.duration<0?this.trigger("warn",{message:"ignoring invalid total duration: "+e.duration}):this.manifest.totalDuration=e.duration},start:function(){e.attributes&&!isNaN(e.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:e.attributes["TIME-OFFSET"],precise:e.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){a.cueOut=e.data},"cue-out-cont":function(){a.cueOutCont=e.data},"cue-in":function(){a.cueIn=e.data}}[e.tagType]||d).call(n)},uri:function(){a.uri=e.uri,r.push(a),this.manifest.targetDuration&&!("duration"in a)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),a.duration=this.manifest.targetDuration),i&&(a.key=i),a.timeline=l,s&&(a.map=s),a={}},comment:function(){},custom:function(){e.segment?(a.custom=a.custom||{},a.custom[e.customType]=e.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[e.customType]=e.data)}})[e.type].call(n)}),t}n()(t,e);var s=t.prototype;return s.push=function(e){this.lineStream.push(e)},s.end=function(){this.lineStream.push("\n")},s.addParser=function(e){this.parseStream.addParser(e)},s.addTagMapper=function(e){this.parseStream.addTagMapper(e)},t}(r)},"3Lai":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentsMemoryStorage=class{constructor(e){this.settings=e,this.cache=new Map}async storeSegment(e){this.cache.set(e.id,{segment:e,lastAccessed:performance.now()})}async getSegmentsMap(e){return this.cache}async getSegment(e,t){const s=this.cache.get(e);if(void 0!==s)return s.lastAccessed=performance.now(),s.segment}async hasSegment(e,t){return this.cache.has(e)}async clean(e,t){const s=[],i=[],n=performance.now();for(const a of this.cache.values())n-a.lastAccessed>this.settings.cachedSegmentExpiration?s.push(a.segment.id):i.push(a);let r=i.length-this.settings.cachedSegmentsCount;if(r>0){i.sort((e,t)=>e.lastAccessed-t.lastAccessed);for(const e of i)if((void 0===t||!t(e.segment.id))&&(s.push(e.segment.id),r--,0==r))break}return s.forEach(e=>this.cache.delete(e)),s.length>0}async destroy(){this.cache.clear()}}},"A+nu":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("+qE3");t.STEEmitter=class extends i.EventEmitter{on(e,t){return super.on(e,t)}emit(e,...t){return super.emit(e,...t)}}},O885:function(e,t,s){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.Events||(t.Events={})).SegmentLoaded="segment_loaded",i.SegmentError="segment_error",i.SegmentAbort="segment_abort",i.PeerConnect="peer_connect",i.PeerClose="peer_close",i.PieceBytesDownloaded="piece_bytes_downloaded",i.PieceBytesUploaded="piece_bytes_uploaded"},OKKN:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("+qE3"),n=s("uOj1"),r=s("iXDm"),a=s("yLkh"),o=s("b7KT");t.Engine=class extends i.EventEmitter{constructor(e={}){super(),this.loader=new n.HybridLoader(e.loader),this.segmentManager=new r.SegmentManager(this.loader,e.segments),Object.keys(n.Events).map(e=>n.Events[e]).forEach(e=>this.loader.on(e,(...t)=>this.emit(e,...t)))}static isSupported(){return n.HybridLoader.isSupported()}createLoaderClass(){return o.createHlsJsLoaderClass(a.HlsJsLoader,this)}async destroy(){await this.segmentManager.destroy()}getSettings(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}getDetails(){return{loader:this.loader.getDetails()}}setPlayingSegment(e,t,s,i){this.segmentManager.setPlayingSegment(e,t,s,i)}setPlayingSegmentByCurrentTime(e){this.segmentManager.setPlayingSegmentByCurrentTime(e)}}},R6j9:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("NOtv"),n=s("A+nu"),r=s("tjlA");var a,o;!function(e){e[e.SegmentData=0]="SegmentData",e[e.SegmentAbsent=1]="SegmentAbsent",e[e.SegmentsMap=2]="SegmentsMap",e[e.SegmentRequest=3]="SegmentRequest",e[e.CancelSegmentRequest=4]="CancelSegmentRequest"}(a||(a={})),function(e){e[e.Loaded=0]="Loaded",e[e.LoadingByHttp=1]="LoadingByHttp"}(o=t.MediaPeerSegmentStatus||(t.MediaPeerSegmentStatus={}));class d{constructor(e,t){this.id=e,this.size=t,this.bytesDownloaded=0,this.pieces=[]}}t.MediaPeer=class extends n.STEEmitter{constructor(e,t){super(),this.peer=e,this.settings=t,this.remoteAddress="",this.downloadingSegmentId=null,this.downloadingSegment=null,this.segmentsMap=new Map,this.debug=i("p2pml:media-peer"),this.timer=null,this.onPeerConnect=()=>{this.debug("peer connect",this.id,this),this.remoteAddress=this.peer.remoteAddress,this.emit("connect",this)},this.onPeerClose=()=>{this.debug("peer close",this.id,this),this.terminateSegmentRequest(),this.emit("close",this)},this.onPeerError=e=>{this.debug("peer error",this.id,e,this)},this.onPeerData=e=>{const t=this.getJsonCommand(e);if(null!=t){if(this.downloadingSegment){this.debug("peer segment download is interrupted by a command",this.id,this);const e=this.downloadingSegment.id;return this.terminateSegmentRequest(),void this.emit("segment-error",this,e,"Segment download is interrupted by a command")}switch(this.debug("peer receive command",this.id,t,this),t.c){case a.SegmentsMap:this.segmentsMap=this.createSegmentsMap(t.m),this.emit("data-updated");break;case a.SegmentRequest:this.emit("segment-request",this,t.i);break;case a.SegmentData:this.downloadingSegmentId===t.i&&(this.downloadingSegment=new d(t.i,t.s),this.cancelResponseTimeoutTimer());break;case a.SegmentAbsent:this.downloadingSegmentId===t.i&&(this.terminateSegmentRequest(),this.segmentsMap.delete(t.i),this.emit("segment-absent",this,t.i))}}else this.receiveSegmentPiece(e)},this.peer.on("connect",this.onPeerConnect),this.peer.on("close",this.onPeerClose),this.peer.on("error",this.onPeerError),this.peer.on("data",this.onPeerData),this.id=e.id}receiveSegmentPiece(e){if(!this.downloadingSegment)return void this.debug("peer segment not requested",this.id,this);this.downloadingSegment.bytesDownloaded+=e.byteLength,this.downloadingSegment.pieces.push(e),this.emit("bytes-downloaded",this,e.byteLength);const t=this.downloadingSegment.id;if(this.downloadingSegment.bytesDownloaded==this.downloadingSegment.size){const e=new Uint8Array(this.downloadingSegment.size);let s=0;for(const t of this.downloadingSegment.pieces)e.set(new Uint8Array(t),s),s+=t.byteLength;this.debug("peer segment download done",this.id,t,this),this.terminateSegmentRequest(),this.emit("segment-loaded",this,t,e.buffer)}else this.downloadingSegment.bytesDownloaded>this.downloadingSegment.size&&(this.debug("peer segment download bytes mismatch",this.id,t,this),this.terminateSegmentRequest(),this.emit("segment-error",this,t,"Too many bytes received for segment"))}getJsonCommand(e){const t=new Uint8Array(e);if(123==t[0]&&34==t[1]&&125==t[e.byteLength-1])try{return JSON.parse((new TextDecoder).decode(e))}catch(s){}return null}createSegmentsMap(e){if(null==e||!(e instanceof Object))return new Map;const t=new Map;for(const s of Object.keys(e)){const i=e[s];if(!(i instanceof Array&&2===i.length&&"string"==typeof i[0]&&i[1]instanceof Array))return new Map;const n=i[0].split("|"),r=i[1];if(n.length!==r.length)return new Map;for(let e=0;e<n.length;e++){const i=r[e];if("number"!=typeof i||void 0===o[i])return new Map;t.set(`${s}+${n[e]}`,i)}}return t}sendCommand(e){this.debug("peer send command",this.id,e,this),this.peer.write(JSON.stringify(e))}destroy(){this.debug("peer destroy",this.id,this),this.terminateSegmentRequest(),this.peer.destroy()}getDownloadingSegmentId(){return this.downloadingSegmentId}getSegmentsMap(){return this.segmentsMap}sendSegmentsMap(e){this.sendCommand({c:a.SegmentsMap,m:e})}sendSegmentData(e,t){this.sendCommand({c:a.SegmentData,i:e,s:t.byteLength});let s=t.byteLength;for(;s>0;){const e=s>=this.settings.webRtcMaxMessageSize?this.settings.webRtcMaxMessageSize:s,i=r.Buffer.from(t,t.byteLength-s,e);this.peer.write(i),s-=e}this.emit("bytes-uploaded",this,t.byteLength)}sendSegmentAbsent(e){this.sendCommand({c:a.SegmentAbsent,i:e})}requestSegment(e){if(this.downloadingSegmentId)throw new Error("A segment is already downloading: "+this.downloadingSegmentId);this.sendCommand({c:a.SegmentRequest,i:e}),this.downloadingSegmentId=e,this.runResponseTimeoutTimer()}cancelSegmentRequest(){let e;if(this.downloadingSegmentId){const t=this.downloadingSegmentId;e=this.downloadingSegment?this.downloadingSegment.pieces:void 0,this.terminateSegmentRequest(),this.sendCommand({c:a.CancelSegmentRequest,i:t})}return e}runResponseTimeoutTimer(){this.timer=setTimeout(()=>{if(this.timer=null,!this.downloadingSegmentId)return;const e=this.downloadingSegmentId;this.cancelSegmentRequest(),this.emit("segment-timeout",this,e)},this.settings.p2pSegmentDownloadTimeout)}cancelResponseTimeoutTimer(){this.timer&&(clearTimeout(this.timer),this.timer=null)}terminateSegmentRequest(){this.downloadingSegmentId=null,this.downloadingSegment=null,this.cancelResponseTimeoutTimer()}}},b7KT:function(e,t){e.exports.createHlsJsLoaderClass=function(e,t){function s(){this.impl=new e(t.segmentManager),this.stats=this.impl.stats}return s.prototype.load=function(e,t,s){this.context=e,this.impl.load(e,t,s)},s.prototype.abort=function(){this.impl.abort(this.context)},s.prototype.destroy=function(){this.context&&this.impl.abort(this.context)},s.getEngine=function(){return t},s}},fnjI:function(e,t,s){var i=s("P7XM"),n=s("tnIz"),r=s("hwdV").Buffer,a=[1518500249,1859775393,-1894007588,-899497514],o=new Array(80);function d(){this.init(),this._w=o,n.call(this,64,56)}function g(e){return e<<5|e>>>27}function h(e){return e<<30|e>>>2}function l(e,t,s,i){return 0===e?t&s|~t&i:2===e?t&s|t&i|s&i:t^s^i}i(d,n),d.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},d.prototype._update=function(e){for(var t,s=this._w,i=0|this._a,n=0|this._b,r=0|this._c,o=0|this._d,d=0|this._e,u=0;u<16;++u)s[u]=e.readInt32BE(4*u);for(;u<80;++u)s[u]=(t=s[u-3]^s[u-8]^s[u-14]^s[u-16])<<1|t>>>31;for(var m=0;m<80;++m){var c=~~(m/20),p=g(i)+l(c,n,r,o)+d+s[m]+a[c]|0;d=o,o=r,r=h(n),n=i,i=p}this._a=i+this._a|0,this._b=n+this._b|0,this._c=r+this._c|0,this._d=o+this._d|0,this._e=d+this._e|0},d.prototype._hash=function(){var e=r.allocUnsafe(20);return e.writeInt32BE(0|this._a,0),e.writeInt32BE(0|this._b,4),e.writeInt32BE(0|this._c,8),e.writeInt32BE(0|this._d,12),e.writeInt32BE(0|this._e,16),e},e.exports=d},iXDm:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("uOj1"),n=s("10ky"),r={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};t.SegmentManager=class{constructor(e,t={}){this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.playQueue=[],this.onSegmentLoaded=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&g(this.segmentRequest.segmentByterange)===e.range&&(this.segmentRequest.onSuccess(e.data.slice(0),e.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(e,t)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&g(this.segmentRequest.segmentByterange)===e.range&&(this.segmentRequest.onError(t),this.segmentRequest=null)},this.onSegmentAbort=e=>{this.segmentRequest&&this.segmentRequest.segmentUrl===e.url&&g(this.segmentRequest.segmentByterange)===e.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},r),t),this.loader=e,this.loader.on(i.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(i.Events.SegmentError,this.onSegmentError),this.loader.on(i.Events.SegmentAbort,this.onSegmentAbort)}getSettings(){return this.settings}processPlaylist(e,t,s){const i=new n.Parser;i.push(t),i.end();const r=new a(e,s,i.manifest);if(r.manifest.playlists){this.masterPlaylist=r;for(const[e,t]of this.variantPlaylists){const{streamSwarmId:s,found:i,index:n}=this.getStreamSwarmId(t.requestUrl);i?(t.streamSwarmId=s,t.streamId="V"+n.toString()):this.variantPlaylists.delete(e)}}else{const{streamSwarmId:t,found:s,index:i}=this.getStreamSwarmId(e);(s||null===this.masterPlaylist)&&(r.streamSwarmId=t,r.streamId=null===this.masterPlaylist?void 0:"V"+i.toString(),this.variantPlaylists.set(e,r),this.updateSegments())}}async loadPlaylist(e){const t=this.settings.assetsStorage;let s;if(void 0!==t){let i;i=this.getMasterSwarmId(),void 0===i&&(i=e.split("?")[0]);const n=await t.getAsset(e,void 0,i);void 0!==n?s={responseURL:n.responseUri,response:n.data}:(s=await this.loadContent(e,"text"),t.storeAsset({masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e,masterSwarmId:i,requestUri:e,responseUri:s.responseURL,data:s.response}))}else s=await this.loadContent(e,"text");return this.processPlaylist(e,s.response,s.responseURL),s}async loadSegment(e,t){const s=this.getSegmentLocation(e,t),i=g(t);if(!s){let t;const s=this.settings.assetsStorage;if(void 0!==s){let n,r=null!==this.masterPlaylist?this.masterPlaylist.requestUrl:void 0;if(n=this.getMasterSwarmId(),void 0===n&&1===this.variantPlaylists.size&&(n=this.variantPlaylists.values().next().value.requestUrl.split("?")[0]),void 0===r&&1===this.variantPlaylists.size&&(r=this.variantPlaylists.values().next().value.requestUrl),void 0!==n&&void 0!==r){const a=await s.getAsset(e,i,n);if(void 0!==a)t=a.data;else{const a=await this.loadContent(e,"arraybuffer",i);t=a.response,s.storeAsset({masterManifestUri:r,masterSwarmId:n,requestUri:e,requestRange:i,responseUri:a.responseURL,data:t})}}}return void 0===t&&(t=(await this.loadContent(e,"arraybuffer",i)).response),{content:t,downloadBandwidth:0}}const n=(s.playlist.manifest.mediaSequence?s.playlist.manifest.mediaSequence:0)+s.segmentIndex;this.playQueue.length>0&&this.playQueue[this.playQueue.length-1].segmentSequence!==n-1&&(this.playQueue=[]),this.segmentRequest&&this.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const r=new Promise((i,r)=>{this.segmentRequest=new o(e,t,n,s.playlist.requestUrl,(e,t)=>i({content:e,downloadBandwidth:t}),e=>r(e))});return this.playQueue.push({segmentUrl:e,segmentByterange:t,segmentSequence:n}),this.loadSegments(s.playlist,s.segmentIndex,!0),r}setPlayingSegment(e,t,s,i){const n=this.playQueue.findIndex(s=>s.segmentUrl==e&&d(s.segmentByterange,t));n>=0&&(this.playQueue=this.playQueue.slice(n),this.playQueue[0].playPosition={start:s,duration:i},this.updateSegments())}setPlayingSegmentByCurrentTime(e){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const t=this.playQueue[0].playPosition;t.start+t.duration-e<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}abortSegment(e,t){this.segmentRequest&&this.segmentRequest.segmentUrl===e&&d(this.segmentRequest.segmentByterange,t)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}async destroy(){this.segmentRequest&&(this.segmentRequest.onError("Loading aborted: object destroyed"),this.segmentRequest=null),this.masterPlaylist=null,this.variantPlaylists.clear(),this.playQueue=[],void 0!==this.settings.assetsStorage&&await this.settings.assetsStorage.destroy(),await this.loader.destroy()}updateSegments(){if(!this.segmentRequest)return;const e=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByterange);e&&this.loadSegments(e.playlist,e.segmentIndex,!1)}getSegmentLocation(e,t){for(const s of this.variantPlaylists.values()){const i=s.getSegmentIndex(e,t);if(i>=0)return{playlist:s,segmentIndex:i}}}async loadSegments(e,t,s){const i=[],n=e.manifest.segments,r=e.manifest.mediaSequence?e.manifest.mediaSequence:0;let a=null,o=Math.max(0,this.playQueue.length-1);const d=this.getMasterSwarmId();for(let h=t;h<n.length&&i.length<this.settings.forwardSegmentCount;++h){const t=e.manifest.segments[h],n=e.getSegmentAbsoluteUrl(t.uri),l=t.byterange,u=this.getSegmentId(e,r+h);i.push({id:u,url:n,masterSwarmId:void 0!==d?d:e.streamSwarmId,masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:e.requestUrl,streamId:e.streamId,sequence:(r+h).toString(),range:g(l),priority:o++}),s&&!a&&(a=u)}if(this.loader.load(i,e.streamSwarmId),a){const e=await this.loader.getSegment(a);e&&this.onSegmentLoaded(e)}}getSegmentId(e,t){return`${e.streamSwarmId}+${t}`}getMasterSwarmId(){const e=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==e?e:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}getStreamSwarmId(e){const t=this.getMasterSwarmId();if(null!==this.masterPlaylist)for(let s=0;s<this.masterPlaylist.manifest.playlists.length;++s)if(new URL(this.masterPlaylist.manifest.playlists[s].uri,this.masterPlaylist.responseUrl).toString()===e)return{streamSwarmId:`${t}+V${s}`,found:!0,index:s};return{streamSwarmId:void 0!==t?t:e.split("?")[0],found:!1,index:-1}}async loadContent(e,t,s){return new Promise((i,n)=>{const r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType=t,s&&r.setRequestHeader("Range",s),r.addEventListener("readystatechange",()=>{4===r.readyState&&(r.status>=200&&r.status<300?i(r):n(r.statusText))});const a=this.loader.getSettings().xhrSetup;a&&a(r,e),r.send()})}};class a{constructor(e,t,s){this.requestUrl=e,this.responseUrl=t,this.manifest=s,this.streamSwarmId=""}getSegmentIndex(e,t){for(let s=0;s<this.manifest.segments.length;++s){const i=this.manifest.segments[s];if(e===this.getSegmentAbsoluteUrl(i.uri)&&d(i.byterange,t))return s}return-1}getSegmentAbsoluteUrl(e){return new URL(e,this.responseUrl).toString()}}class o{constructor(e,t,s,i,n,r){this.segmentUrl=e,this.segmentByterange=t,this.segmentSequence=s,this.playlistRequestUrl=i,this.onSuccess=n,this.onError=r}}function d(e,t){return void 0===e?void 0===t:void 0!==t&&e.length===t.length&&e.offset===t.offset}function g(e){if(void 0!==e)return`bytes=${e.offset}-${e.offset+e.length-1}`}},lcUr:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("NOtv"),n=s("O885"),r=s("+qE3"),a=s("0ovO"),o=s("n5Qj"),d=s("R6j9"),g=s("xzjP"),h=s("3Lai"),l=s("3oOE"),u={cachedSegmentExpiration:3e5,cachedSegmentsCount:30,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:1,simultaneousHttpDownloads:2,httpDownloadProbability:.1,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1e4,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:4e3,httpUseRanges:!1,simultaneousP2PDownloads:3,p2pDownloadMaxPriority:20,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:s("BRrH").config};t.HybridLoader=class extends r.EventEmitter{constructor(e={}){super(),this.debug=i("p2pml:hybrid-loader"),this.debugSegments=i("p2pml:hybrid-loader-segments"),this.segmentsQueue=[],this.bandwidthApproximator=new g.BandwidthApproximator,this.httpDownloadInitialTimeoutTimestamp=-1/0,this.processInitialSegmentTimeout=async()=>{if(void 0!==this.httpRandomDownloadInterval){if(void 0!==this.masterSwarmId){const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}this.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment)}},this.downloadRandomSegmentOverHttp=async()=>{if(void 0===this.masterSwarmId||void 0===this.httpRandomDownloadInterval||this.httpDownloadInitialTimeoutTimestamp!==-1/0||this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads||this.settings.httpDownloadProbabilitySkipIfNoPeers&&0===this.p2pManager.getPeers().size||this.settings.consumeOnly)return;const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId),t=this.p2pManager.getOvrallSegmentsMap(),s=this.segmentsQueue.filter(s=>!this.p2pManager.isDownloading(s)&&!this.httpManager.isDownloading(s)&&!t.has(s.id)&&!this.httpManager.isFailed(s)&&s.priority<=this.settings.httpDownloadMaxPriority&&!e.has(s.id));if(0==s.length)return;if(Math.random()>this.settings.httpDownloadProbability*s.length)return;const i=s[Math.floor(Math.random()*s.length)];this.debugSegments("HTTP download (random)",i.priority,i.url),this.httpManager.download(i),this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))},this.onPieceBytesDownloaded=(e,t,s)=>{this.bandwidthApproximator.addBytes(t,this.now()),this.emit(n.Events.PieceBytesDownloaded,e,t,s)},this.onPieceBytesUploaded=(e,t,s)=>{this.emit(n.Events.PieceBytesUploaded,e,t,s)},this.onSegmentLoaded=async(e,t,s)=>{if(this.debugSegments("segment loaded",e.id,e.url),void 0===this.masterSwarmId)return;let i;e.data=t,e.downloadBandwidth=this.bandwidthApproximator.getBandwidth(this.now()),await this.segmentsStorage.storeSegment(e),this.emit(n.Events.SegmentLoaded,e,s),i=void 0===i?await this.segmentsStorage.getSegmentsMap(this.masterSwarmId):i,this.processSegmentsQueue(i),this.settings.consumeOnly||this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(i))},this.onSegmentError=async(e,t,s)=>{if(this.debugSegments("segment error",e.id,e.url,s,t),this.emit(n.Events.SegmentError,e,t,s),void 0!==this.masterSwarmId){const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}},this.onPeerConnect=async e=>{this.emit(n.Events.PeerConnect,e),this.settings.consumeOnly||void 0===this.masterSwarmId||this.p2pManager.sendSegmentsMap(e.id,this.createSegmentsMap(await this.segmentsStorage.getSegmentsMap(this.masterSwarmId)))},this.onPeerClose=e=>{this.emit(n.Events.PeerClose,e)},this.onTrackerUpdate=async e=>{if(this.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==e.incomplete&&e.incomplete<=1&&(this.debugSegments("cancel initial HTTP download timeout - no peers"),this.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==this.masterSwarmId)){const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}},this.settings=Object.assign(Object.assign({},u),e),e.bufferedSegmentsCount&&(void 0===e.p2pDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=e.bufferedSegmentsCount),void 0===e.httpDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=e.bufferedSegmentsCount),delete this.settings.bufferedSegmentsCount),this.segmentsStorage=void 0===this.settings.segmentsStorage?new h.SegmentsMemoryStorage(this.settings):this.settings.segmentsStorage,this.debug("loader settings",this.settings),this.httpManager=this.createHttpManager(),this.httpManager.on("segment-loaded",this.onSegmentLoaded),this.httpManager.on("segment-error",this.onSegmentError),this.httpManager.on("bytes-downloaded",e=>this.onPieceBytesDownloaded("http",e)),this.p2pManager=this.createP2PManager(),this.p2pManager.on("segment-loaded",this.onSegmentLoaded),this.p2pManager.on("segment-error",this.onSegmentError),this.p2pManager.on("peer-data-updated",async()=>{if(void 0===this.masterSwarmId)return;const e=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(e)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(e))}),this.p2pManager.on("bytes-downloaded",(e,t)=>this.onPieceBytesDownloaded("p2p",e,t)),this.p2pManager.on("bytes-uploaded",(e,t)=>this.onPieceBytesUploaded("p2p",e,t)),this.p2pManager.on("peer-connected",this.onPeerConnect),this.p2pManager.on("peer-closed",this.onPeerClose),this.p2pManager.on("tracker-update",this.onTrackerUpdate)}static isSupported(){const e=l();return e&&void 0!==e.RTCPeerConnection.prototype.createDataChannel}createHttpManager(){return new a.HttpMediaManager(this.settings)}createP2PManager(){return new o.P2PMediaManager(this.segmentsStorage,this.settings)}async load(e,t){void 0===this.httpRandomDownloadInterval&&(this.httpRandomDownloadInterval=setInterval(this.downloadRandomSegmentOverHttp,this.settings.httpDownloadProbabilityInterval),this.settings.httpDownloadInitialTimeout>0&&this.settings.httpDownloadInitialTimeoutPerSegment>0&&(this.debugSegments("enable initial HTTP download timeout",this.settings.httpDownloadInitialTimeout,"per segment",this.settings.httpDownloadInitialTimeoutPerSegment),this.httpDownloadInitialTimeoutTimestamp=this.now(),setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment+100))),e.length>0&&(this.masterSwarmId=e[0].masterSwarmId),void 0!==this.masterSwarmId&&this.p2pManager.setStreamSwarmId(t,this.masterSwarmId),this.debug("load segments");let s=!1;for(const r of this.segmentsQueue)e.find(e=>e.url==r.url)||(this.debug("remove segment",r.url),this.httpManager.isDownloading(r)?(s=!0,this.httpManager.abort(r)):this.p2pManager.abort(r),this.emit(n.Events.SegmentAbort,r));if(this.debug.enabled)for(const n of e)this.segmentsQueue.find(e=>e.url==n.url)||this.debug("add segment",n.url);if(this.segmentsQueue=e,void 0===this.masterSwarmId)return;let i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);s=this.processSegmentsQueue(i)||s,await this.cleanSegmentsStorage()&&(i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId),s=!0),s&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(i))}async getSegment(e){return void 0===this.masterSwarmId?void 0:this.segmentsStorage.getSegment(e,this.masterSwarmId)}getSettings(){return this.settings}getDetails(){return{peerId:this.p2pManager.getPeerId()}}async destroy(){void 0!==this.httpRandomDownloadInterval&&(clearInterval(this.httpRandomDownloadInterval),this.httpRandomDownloadInterval=void 0),this.httpDownloadInitialTimeoutTimestamp=-1/0,this.segmentsQueue=[],this.httpManager.destroy(),this.p2pManager.destroy(),this.masterSwarmId=void 0,await this.segmentsStorage.destroy()}processSegmentsQueue(e){if(this.debugSegments("process segments queue. priority",this.segmentsQueue.length>0?this.segmentsQueue[0].priority:0),void 0===this.masterSwarmId||0===this.segmentsQueue.length)return!1;let t,s=!1,i=!0;if(this.httpDownloadInitialTimeoutTimestamp!==-1/0){let t;for(const i of this.segmentsQueue)if(!e.has(i.id)){t=i.priority;break}const s=this.now()-this.httpDownloadInitialTimeoutTimestamp;i=s>=this.settings.httpDownloadInitialTimeout||void 0!==t&&s>this.settings.httpDownloadInitialTimeoutPerSegment&&t<=0,i&&(this.debugSegments("cancel initial HTTP download timeout - timed out"),this.httpDownloadInitialTimeoutTimestamp=-1/0)}for(let n=0;n<this.segmentsQueue.length;n++){const r=this.segmentsQueue[n];if(!e.has(r.id)&&!this.httpManager.isDownloading(r)){if(r.priority<=this.settings.requiredSegmentsPriority&&i&&!this.httpManager.isFailed(r)){if(this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads)for(let e=this.segmentsQueue.length-1;e>n;e--){const t=this.segmentsQueue[e];if(this.httpManager.isDownloading(t)){this.debugSegments("cancel HTTP download",t.priority,t.url),this.httpManager.abort(t);break}}if(this.httpManager.getActiveDownloadsCount()<this.settings.simultaneousHttpDownloads){const e=this.p2pManager.abort(r);this.httpManager.download(r,e),this.debugSegments("HTTP download (priority)",r.priority,r.url),s=!0;continue}}if(!this.p2pManager.isDownloading(r))if(r.priority<=this.settings.requiredSegmentsPriority){if(t=t||this.p2pManager.getOvrallSegmentsMap(),t.get(r.id)!==d.MediaPeerSegmentStatus.Loaded)continue;if(this.p2pManager.getActiveDownloadsCount()>=this.settings.simultaneousP2PDownloads)for(let e=this.segmentsQueue.length-1;e>n;e--){const t=this.segmentsQueue[e];if(this.p2pManager.isDownloading(t)){this.debugSegments("cancel P2P download",t.priority,t.url),this.p2pManager.abort(t);break}}if(this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&this.p2pManager.download(r)){this.debugSegments("P2P download (priority)",r.priority,r.url);continue}}else this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&r.priority<=this.settings.p2pDownloadMaxPriority&&this.p2pManager.download(r)&&this.debugSegments("P2P download",r.priority,r.url)}}return s}getStreamSwarmId(e){return void 0===e.streamId?e.masterSwarmId:`${e.masterSwarmId}+${e.streamId}`}createSegmentsMap(e){const t={},s=(e,s)=>{const i=this.getStreamSwarmId(e),n=e.sequence;let r=t[i];void 0===r&&(r=["",[]],t[i]=r);const a=r[1];r[0]+=0==a.length?n:`|${n}`,a.push(s)};for(const i of e.values())s(i.segment,d.MediaPeerSegmentStatus.Loaded);for(const i of this.httpManager.getActiveDownloads().values())s(i.segment,d.MediaPeerSegmentStatus.LoadingByHttp);return t}async cleanSegmentsStorage(){return void 0!==this.masterSwarmId&&this.segmentsStorage.clean(this.masterSwarmId,e=>void 0!==this.segmentsQueue.find(t=>t.id===e))}now(){return performance.now()}}},n5Qj:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s("NOtv"),n=s("J6t0"),r=s("A+nu"),a=s("R6j9"),o=s("tjlA"),d=s("fnjI"),g=`-WW${s("uOj1").version.replace(/\d*./g,e=>("0"+parseInt(e,10)%100).slice(-2)).slice(0,4)}-`;class h{constructor(e,t){this.peerId=e,this.segment=t}}t.P2PMediaManager=class extends r.STEEmitter{constructor(e,t){super(),this.sementsStorage=e,this.settings=t,this.trackerClient=null,this.peers=new Map,this.peerCandidates=new Map,this.peerSegmentRequests=new Map,this.streamSwarmId=null,this.debug=i("p2pml:p2p-media-manager"),this.pendingTrackerClient=null,this.onTrackerError=e=>{this.debug("tracker error",e)},this.onTrackerWarning=e=>{this.debug("tracker warning",e)},this.onTrackerUpdate=e=>{this.debug("tracker update",e),this.emit("tracker-update",e)},this.onTrackerPeer=e=>{if(this.debug("tracker peer",e.id,e),this.peers.has(e.id))return this.debug("tracker peer already connected",e.id,e),void e.destroy();const t=new a.MediaPeer(e,this.settings);t.on("connect",this.onPeerConnect),t.on("close",this.onPeerClose),t.on("data-updated",this.onPeerDataUpdated),t.on("segment-request",this.onSegmentRequest),t.on("segment-loaded",this.onSegmentLoaded),t.on("segment-absent",this.onSegmentAbsent),t.on("segment-error",this.onSegmentError),t.on("segment-timeout",this.onSegmentTimeout),t.on("bytes-downloaded",this.onPieceBytesDownloaded),t.on("bytes-uploaded",this.onPieceBytesUploaded);let s=this.peerCandidates.get(t.id);s||(s=[],this.peerCandidates.set(t.id,s)),s.push(t)},this.onPieceBytesDownloaded=(e,t)=>{this.emit("bytes-downloaded",t,e.id)},this.onPieceBytesUploaded=(e,t)=>{this.emit("bytes-uploaded",t,e.id)},this.onPeerConnect=e=>{if(this.peers.get(e.id))return this.debug("tracker peer already connected (in peer connect)",e.id,e),void e.destroy();this.peers.set(e.id,e);const t=this.peerCandidates.get(e.id);if(t){for(const s of t)s!=e&&s.destroy();this.peerCandidates.delete(e.id)}this.emit("peer-connected",{id:e.id,remoteAddress:e.remoteAddress})},this.onPeerClose=e=>{if(this.peers.get(e.id)!=e){const t=this.peerCandidates.get(e.id);if(!t)return;const s=t.indexOf(e);return-1!=s&&t.splice(s,1),void(0==t.length&&this.peerCandidates.delete(e.id))}for(const[t,s]of this.peerSegmentRequests)s.peerId==e.id&&this.peerSegmentRequests.delete(t);this.peers.delete(e.id),this.emit("peer-data-updated"),this.emit("peer-closed",e.id)},this.onPeerDataUpdated=()=>{this.emit("peer-data-updated")},this.onSegmentRequest=async(e,t)=>{if(void 0===this.masterSwarmId)return;const s=await this.sementsStorage.getSegment(t,this.masterSwarmId);s?e.sendSegmentData(t,s.data):e.sendSegmentAbsent(t)},this.onSegmentLoaded=async(e,t,s)=>{const i=this.peerSegmentRequests.get(t);if(!i)return;const n=i.segment;if(this.settings.segmentValidator)try{await this.settings.segmentValidator(Object.assign(Object.assign({},n),{data:s}),"p2p",e.id)}catch(r){return this.debug("segment validator failed",r),this.peerSegmentRequests.delete(t),this.emit("segment-error",n,r,e.id),void this.onPeerClose(e)}this.peerSegmentRequests.delete(t),this.emit("segment-loaded",n,s,e.id)},this.onSegmentAbsent=(e,t)=>{this.peerSegmentRequests.delete(t),this.emit("peer-data-updated")},this.onSegmentError=(e,t,s)=>{const i=this.peerSegmentRequests.get(t);i&&(this.peerSegmentRequests.delete(t),this.emit("segment-error",i.segment,s,e.id))},this.onSegmentTimeout=(e,t)=>{const s=this.peerSegmentRequests.get(t);s&&(this.peerSegmentRequests.delete(t),e.destroy(),this.peers.delete(s.peerId)&&this.emit("peer-data-updated"))},this.peerId=t.useP2P?function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t=g;for(let s=0;s<20-g.length;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return(new TextEncoder).encode(t).buffer}():new ArrayBuffer(0),this.debug.enabled&&this.debug("peer ID",this.getPeerId(),(new TextDecoder).decode(this.peerId))}getPeers(){return this.peers}getPeerId(){return o.Buffer.from(this.peerId).toString("hex")}async setStreamSwarmId(e,t){if(this.streamSwarmId===e)return;this.destroy(!0),this.streamSwarmId=e,this.masterSwarmId=t,this.debug("stream swarm ID",this.streamSwarmId),this.pendingTrackerClient={isDestroyed:!1};const s=this.pendingTrackerClient,i=(new d).update(2+this.streamSwarmId).digest();s.isDestroyed?null!=this.trackerClient&&(this.trackerClient.destroy(),this.trackerClient=null):(this.pendingTrackerClient=null,this.createClient(i))}createClient(e){if(!this.settings.useP2P)return;const t={infoHash:o.Buffer.from(e,0,20),peerId:o.Buffer.from(this.peerId,0,20),announce:this.settings.trackerAnnounce,rtcConfig:this.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:this.settings.peerRequestsPerAnnounce})};let s=this.trackerClient;this.trackerClient=new n(t),this.trackerClient.on("error",this.onTrackerError),this.trackerClient.on("warning",this.onTrackerWarning),this.trackerClient.on("update",this.onTrackerUpdate),this.trackerClient.on("peer",this.onTrackerPeer),this.trackerClient.start(),null!=s&&(s.destroy(),s=null)}download(e){if(this.isDownloading(e))return!1;const t=[];for(const i of this.peers.values())null==i.getDownloadingSegmentId()&&i.getSegmentsMap().get(e.id)===a.MediaPeerSegmentStatus.Loaded&&t.push(i);if(0===t.length)return!1;const s=t[Math.floor(Math.random()*t.length)];return s.requestSegment(e.id),this.peerSegmentRequests.set(e.id,new h(s.id,e)),!0}abort(e){let t;const s=this.peerSegmentRequests.get(e.id);if(s){const i=this.peers.get(s.peerId);i&&(t=i.cancelSegmentRequest()),this.peerSegmentRequests.delete(e.id)}return t}isDownloading(e){return this.peerSegmentRequests.has(e.id)}getActiveDownloadsCount(){return this.peerSegmentRequests.size}destroy(e=!1){this.streamSwarmId=null,this.trackerClient&&(this.trackerClient.stop(),e?(this.trackerClient.removeAllListeners("error"),this.trackerClient.removeAllListeners("warning"),this.trackerClient.removeAllListeners("update"),this.trackerClient.removeAllListeners("peer")):(this.trackerClient.destroy(),this.trackerClient=null)),this.pendingTrackerClient&&(this.pendingTrackerClient.isDestroyed=!0,this.pendingTrackerClient=null),this.peers.forEach(e=>e.destroy()),this.peers.clear(),this.peerSegmentRequests.clear();for(const t of this.peerCandidates.values())for(const e of t)e.destroy();this.peerCandidates.clear()}sendSegmentsMapToAll(e){this.peers.forEach(t=>t.sendSegmentsMap(e))}sendSegmentsMap(e,t){const s=this.peers.get(e);s&&s.sendSegmentsMap(t)}getOvrallSegmentsMap(){const e=new Map;for(const t of this.peers.values())for(const[s,i]of t.getSegmentsMap())i===a.MediaPeerSegmentStatus.Loaded?e.set(s,a.MediaPeerSegmentStatus.Loaded):e.get(s)||e.set(s,a.MediaPeerSegmentStatus.LoadingByHttp);return e}}},tlK4:function(e,t,s){"use strict";function i(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}function n(e){e&&e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine&&r(e,e.config.loader.getEngine())}function r(e,t){e.on("hlsFragChanged",(e,s)=>{const i=s.frag;t.setPlayingSegment(i.url,2!==i.byteRange.length?void 0:{offset:i.byteRange[0],length:i.byteRange[1]-i.byteRange[0]},i.start,i.duration)}),e.on("hlsDestroying",async()=>{await t.destroy()}),e.on("hlsError",(s,i)=>{if("bufferStalledError"===i.details){const s=void 0===e.media?e.el_:e.media;if(void 0===s)return;t.setPlayingSegmentByCurrentTime(s.currentTime)}})}Object.defineProperty(t,"__esModule",{value:!0}),t.version="0.6.2",i(s("OKKN")),i(s("iXDm")),t.initHlsJsPlayer=n,t.initClapprPlayer=function(e){e.on("play",()=>{const t=e.core.getCurrentPlayback();t._hls&&!t._hls._p2pm_linitialized&&(t._hls._p2pm_linitialized=!0,n(e.core.getCurrentPlayback()._hls))})},t.initFlowplayerHlsJsPlayer=function(e){e.on("ready",()=>n(e.engine.hlsjs?e.engine.hlsjs:e.engine.hls))},t.initVideoJsContribHlsJsPlayer=function(e){e.ready(()=>{const t=e.tech_.options_;t&&t.hlsjsConfig&&t.hlsjsConfig.loader&&"function"==typeof t.hlsjsConfig.loader.getEngine&&r(e.tech_,t.hlsjsConfig.loader.getEngine())})},t.initVideoJsHlsJsPlugin=function(){null!=videojs&&null!=videojs.Html5Hlsjs&&videojs.Html5Hlsjs.addHook("beforeinitialize",(e,t)=>{t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&r(t,t.config.loader.getEngine())})},t.initMediaElementJsPlayer=function(e){e.addEventListener("hlsFragChanged",t=>{const s=e.hlsPlayer;if(s&&s.config&&s.config.loader&&"function"==typeof s.config.loader.getEngine){const e=s.config.loader.getEngine();if(t.data&&t.data.length>1){const s=t.data[1].frag;e.setPlayingSegment(s.url,2!==s.byteRange.length?void 0:{offset:s.byteRange[0],length:s.byteRange[1]-s.byteRange[0]},s.start,s.duration)}}}),e.addEventListener("hlsDestroying",async()=>{const t=e.hlsPlayer;if(t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine){const e=t.config.loader.getEngine();await e.destroy()}}),e.addEventListener("hlsError",t=>{const s=e.hlsPlayer;s&&s.config&&s.config.loader&&"function"==typeof s.config.loader.getEngine&&void 0!==t.data&&"bufferStalledError"===t.data.details&&s.config.loader.getEngine().setPlayingSegmentByCurrentTime(s.media.currentTime)})},t.initJwPlayer=function(e,t){const s=setInterval(()=>{e.hls&&e.hls.config&&(clearInterval(s),Object.assign(e.hls.config,t),n(e.hls))},200)}},tnIz:function(e,t,s){var i=s("hwdV").Buffer;function n(e,t){this._block=i.alloc(e),this._finalSize=t,this._blockSize=e,this._len=0}n.prototype.update=function(e,t){"string"==typeof e&&(e=i.from(e,t=t||"utf8"));for(var s=this._block,n=this._blockSize,r=e.length,a=this._len,o=0;o<r;){for(var d=a%n,g=Math.min(r-o,n-d),h=0;h<g;h++)s[d+h]=e[o+h];o+=g,(a+=g)%n==0&&this._update(s)}return this._len+=r,this},n.prototype.digest=function(e){var t=this._len%this._blockSize;this._block[t]=128,this._block.fill(0,t+1),t>=this._finalSize&&(this._update(this._block),this._block.fill(0));var s=8*this._len;if(s<=4294967295)this._block.writeUInt32BE(s,this._blockSize-4);else{var i=(4294967295&s)>>>0;this._block.writeUInt32BE((s-i)/4294967296,this._blockSize-8),this._block.writeUInt32BE(i,this._blockSize-4)}this._update(this._block);var n=this._hash();return e?n.toString(e):n},n.prototype._update=function(){throw new Error("_update must be implemented by subclass")},e.exports=n},uOj1:function(e,t,s){"use strict";function i(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),t.version="0.6.2",i(s("O885")),i(s("lcUr"))},xzjP:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=1e3;class n{constructor(e,t){this.value=e,this.timeStamp=t}}t.BandwidthApproximator=class{constructor(){this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[]}addBytes(e,t){for(this.lastBytes.push(new n(e,t)),this.currentBytesSum+=e;t-this.lastBytes[0].timeStamp>i;)this.currentBytesSum-=this.lastBytes.shift().value;this.lastBandwidth.push(new n(this.currentBytesSum/i,t))}getBandwidth(e){for(;0!=this.lastBandwidth.length&&e-this.lastBandwidth[0].timeStamp>6e4;)this.lastBandwidth.shift();let t=0;for(const s of this.lastBandwidth)s.value>t&&(t=s.value);return t}getSmoothInterval(){return i}getMeasureInterval(){return 6e4}}},yLkh:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HlsJsLoader=class{constructor(e){this.stats={},this.segmentManager=e}async load(e,t,s){if(e.type)try{const t=await this.segmentManager.loadPlaylist(e.url);this.successPlaylist(t,e,s)}catch(i){this.error(i,e,s)}else if(e.frag)try{const t=await this.segmentManager.loadSegment(e.url,null==e.rangeStart||null==e.rangeEnd?void 0:{offset:e.rangeStart,length:e.rangeEnd-e.rangeStart});void 0!==t.content&&setTimeout(()=>this.successSegment(t.content,t.downloadBandwidth,e,s),0)}catch(i){setTimeout(()=>this.error(i,e,s),0)}else console.warn("Unknown load request",e)}abort(e){this.segmentManager.abortSegment(e.url,null==e.rangeStart||null==e.rangeEnd?void 0:{offset:e.rangeStart,length:e.rangeEnd-e.rangeStart})}successPlaylist(e,t,s){const i=performance.now();this.stats.trequest=i-300,this.stats.tfirst=i-200,this.stats.tload=i,this.stats.loaded=e.response.length,s.onSuccess({url:e.responseURL,data:e.response},this.stats,t)}successSegment(e,t,s,i){const n=performance.now(),r=e.byteLength/(void 0===t||t<=0?12500:t);this.stats.trequest=n-1-r,this.stats.tfirst=n-r,this.stats.tload=n,this.stats.loaded=e.byteLength,i.onSuccess({url:s.url,data:e},this.stats,s)}error(e,t,s){s.onError(e,t)}}}}]);